<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSplit{% block title_extra %}{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <span class="brand-dot"></span>
                <h1>FinSplit</h1>
            </div>
            <nav class="sidebar-nav">
                <a href="/" {% if request.path == '/' %}class="active"{% endif %}>
                    <i data-lucide="layout-dashboard"></i> Dashboard
                </a>

                <div class="nav-section">Money</div>
                <a href="/transactions" {% if '/transactions' in request.path %}class="active"{% endif %}>
                    <i data-lucide="arrow-left-right"></i> Transactions
                </a>
                <a href="/budgets" {% if '/budgets' in request.path %}class="active"{% endif %}>
                    <i data-lucide="pie-chart"></i> Budgets
                </a>
                <a href="/fixed-payments" {% if '/fixed-payments' in request.path %}class="active"{% endif %}>
                    <i data-lucide="calendar-check"></i> Fixed Payments
                </a>
                <a href="/investments" {% if '/investments' in request.path %}class="active"{% endif %}>
                    <i data-lucide="trending-up"></i> Investments
                </a>
                <a href="/savings" {% if '/savings' in request.path %}class="active"{% endif %}>
                    <i data-lucide="piggy-bank"></i> Savings
                </a>

                <div class="nav-section">Plan</div>
                <a href="/trips" {% if '/trips' in request.path %}class="active"{% endif %}>
                    <i data-lucide="plane"></i> Trips
                </a>

                <div class="nav-section">Tools</div>
                <a href="/scan" {% if '/scan' in request.path %}class="active"{% endif %}>
                    <i data-lucide="scan-line"></i> Scan Receipt
                </a>
                <a href="/import" {% if '/import' in request.path %}class="active"{% endif %}>
                    <i data-lucide="upload"></i> Import
                </a>
                <a href="/split" {% if '/split' in request.path %}class="active"{% endif %}>
                    <i data-lucide="split"></i> Split
                </a>
                <a href="/settings" {% if '/settings' in request.path %}class="active"{% endif %}>
                    <i data-lucide="settings"></i> Settings
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="theme-toggle" id="theme-toggle" type="button">
                    <i data-lucide="moon" id="theme-icon-dark"></i>
                    <i data-lucide="sun" id="theme-icon-light" style="display:none"></i>
                    <span id="theme-label">Dark mode</span>
                </button>
            </div>
        </aside>
        <div class="sidebar-backdrop" id="sidebar-backdrop"></div>

        <div class="main-content">
            <header class="page-header">
                <div class="page-header-left">
                    <button class="mobile-toggle" id="mobile-toggle" type="button">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1>{% block page_title %}FinSplit{% endblock %}</h1>
                </div>
                <div class="page-header-actions">
                    {% block page_actions %}{% endblock %}
                </div>
            </header>

            <div class="page-body">
                {% block content %}{% endblock %}
            </div>

            <div class="page-footer">FinSplit</div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="toast toast-{{ category }}">
                <span class="toast-icon">
                    {% if category == 'success' %}<i data-lucide="check-circle"></i>
                    {% elif category == 'error' %}<i data-lucide="alert-circle"></i>
                    {% else %}<i data-lucide="info"></i>{% endif %}
                </span>
                {{ message }}
                <button class="toast-close" onclick="this.parentElement.classList.add('fade-out');setTimeout(function(){this.parentElement.remove()}.bind(this),300)">
                    <i data-lucide="x" style="width:14px;height:14px"></i>
                </button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}
    </div>

    <!-- FAB + Quick Add -->
    <button class="fab" id="fab" type="button" title="Quick action">
        <i data-lucide="plus"></i>
    </button>
    <div class="fab-menu" id="fab-menu">
        <a href="/transactions">
            <i data-lucide="arrow-left-right"></i> Add Transaction
        </a>
        <a href="#" onclick="event.preventDefault();document.getElementById('quick-add-modal').classList.add('open');closeFab();">
            <i data-lucide="zap"></i> Quick Expense
        </a>
        <a href="/scan">
            <i data-lucide="scan-line"></i> Scan Receipt
        </a>
    </div>
    <div class="fab-backdrop" id="fab-backdrop"></div>

    <!-- Quick Add Modal -->
    <div class="modal-overlay" id="quick-add-modal">
        <div class="modal">
            <div class="modal-handle"></div>
            <h3>Quick Expense</h3>
            <form method="post" action="/transactions/add">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="type" value="expense">
                <div class="form-row cols-2">
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" name="amount" step="0.01" min="0.01" placeholder="0.00" required autofocus>
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select name="currency">
                            <option value="USD">$ USD</option>
                            <option value="UZS">UZS</option>
                        </select>
                    </div>
                </div>
                <div class="form-row cols-2">
                    <div class="form-group">
                        <label>Category</label>
                        <select name="category">
                            <option>Food</option><option>Transport</option>
                            <option>Shopping</option><option>Entertainment</option>
                            <option>Health</option><option>Housing</option>
                            <option>Utilities</option><option>Education</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" name="date">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" name="description" placeholder="What was this for?">
                </div>
                <div class="button-group" style="margin-top:var(--s-4)">
                    <button type="submit" class="btn btn-primary flex-1">Save Expense</button>
                    <button type="button" class="btn btn-outline" onclick="document.getElementById('quick-add-modal').classList.remove('open')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bottom Nav (Mobile) -->
    <nav class="bottom-nav" id="bottom-nav">
        <div class="bottom-nav-inner">
            <a href="/" {% if request.path == '/' %}class="active"{% endif %}>
                <i data-lucide="layout-dashboard"></i>
                <span>Home</span>
            </a>
            <a href="/transactions" {% if '/transactions' in request.path %}class="active"{% endif %}>
                <i data-lucide="arrow-left-right"></i>
                <span>Activity</span>
            </a>
            <a href="#" class="nav-add" onclick="event.preventDefault();document.getElementById('quick-add-modal').classList.add('open');">
                <i data-lucide="plus"></i>
            </a>
            <a href="/budgets" {% if '/budgets' in request.path %}class="active"{% endif %}>
                <i data-lucide="pie-chart"></i>
                <span>Budget</span>
            </a>
            <a href="#" onclick="event.preventDefault();toggleSidebarFromNav();">
                <i data-lucide="menu"></i>
                <span>More</span>
            </a>
        </div>
    </nav>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>lucide.createIcons();</script>
    {% block scripts %}{% endblock %}
    <script>
    (function() {
        var sb = document.getElementById('sidebar');
        var bd = document.getElementById('sidebar-backdrop');
        var btn = document.getElementById('mobile-toggle');
        function toggleSidebar() { sb.classList.toggle('open'); }
        function closeSidebar() { sb.classList.remove('open'); }
        if (btn) btn.addEventListener('click', toggleSidebar);
        if (bd) bd.addEventListener('click', closeSidebar);
        sb.querySelectorAll('a').forEach(function(a) { a.addEventListener('click', closeSidebar); });
        window.toggleSidebarFromNav = toggleSidebar;
    })();
    </script>
    <script>
    (function() {
        var saved = localStorage.getItem('theme');
        var html = document.documentElement;
        var darkIcon = document.getElementById('theme-icon-dark');
        var lightIcon = document.getElementById('theme-icon-light');
        var label = document.getElementById('theme-label');

        function setTheme(dark) {
            html.setAttribute('data-theme', dark ? 'dark' : 'light');
            localStorage.setItem('theme', dark ? 'dark' : 'light');
            if (darkIcon && lightIcon && label) {
                darkIcon.style.display = dark ? 'none' : '';
                lightIcon.style.display = dark ? '' : 'none';
                label.textContent = dark ? 'Light mode' : 'Dark mode';
            }
        }

        if (saved === 'dark') setTheme(true);
        else if (saved === 'light') setTheme(false);

        var toggleBtn = document.getElementById('theme-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                setTheme(html.getAttribute('data-theme') !== 'dark');
                lucide.createIcons();
            });
        }
    })();
    </script>
    <script>
    /* Toast auto-dismiss */
    (function() {
        var toasts = document.querySelectorAll('.toast');
        toasts.forEach(function(el, i) {
            setTimeout(function() {
                el.classList.add('fade-out');
                setTimeout(function() { el.remove(); }, 400);
            }, 4000 + i * 500);
        });
    })();
    </script>
    <script>
    /* FAB toggle */
    (function() {
        var fab = document.getElementById('fab');
        var menu = document.getElementById('fab-menu');
        var backdrop = document.getElementById('fab-backdrop');
        function openFab() { menu.classList.add('open'); backdrop.classList.add('open'); fab.style.transform = 'rotate(45deg)'; }
        function closeFabFn() { menu.classList.remove('open'); backdrop.classList.remove('open'); fab.style.transform = ''; }
        fab.addEventListener('click', function() { menu.classList.contains('open') ? closeFabFn() : openFab(); });
        backdrop.addEventListener('click', closeFabFn);
        window.closeFab = closeFabFn;
    })();
    </script>
    <script>
    /* Quick Add Modal */
    (function() {
        var modal = document.getElementById('quick-add-modal');
        modal.addEventListener('click', function(e) { if (e.target === modal) modal.classList.remove('open'); });
    })();
    </script>
    <script>
    /* Count-up animation for stat values */
    (function() {
        function animateValue(el, start, end, duration) {
            var prefix = '', suffix = '';
            var text = el.textContent.trim();
            var match = text.match(/^([^0-9\-]*)([\-]?[\d,]+\.?\d*)(.*)/);
            if (!match) return;
            prefix = match[1]; suffix = match[3];
            end = parseFloat(match[2].replace(/,/g, ''));
            if (isNaN(end)) return;
            var decimals = match[2].includes('.') ? match[2].split('.')[1].length : 0;
            var startTime = null;
            function step(ts) {
                if (!startTime) startTime = ts;
                var p = Math.min((ts - startTime) / duration, 1);
                p = 1 - Math.pow(1 - p, 3);
                var val = start + (end - start) * p;
                el.textContent = prefix + val.toLocaleString('en-US', {minimumFractionDigits: decimals, maximumFractionDigits: decimals}) + suffix;
                if (p < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }
        document.querySelectorAll('.stat-value, .stat-value-hero').forEach(function(el) {
            animateValue(el, 0, 0, 800);
        });
    })();
    </script>
    <script>
    /* Telegram WebApp */
    (function() {
        var tg = window.Telegram && window.Telegram.WebApp;
        if (!tg || !tg.initData) return;
        document.body.classList.add('tg-mode');
        tg.expand();
        tg.ready();
        if (tg.themeParams.bg_color) document.documentElement.style.setProperty('--tg-bg', tg.themeParams.bg_color);
        if (tg.themeParams.text_color) document.documentElement.style.setProperty('--tg-text', tg.themeParams.text_color);
        if (tg.themeParams.button_color) document.documentElement.style.setProperty('--tg-button', tg.themeParams.button_color);
        tg.BackButton.onClick(function() { window.history.back(); });
        if (window.location.pathname !== '/') tg.BackButton.show();
        var bottomNav = document.getElementById('bottom-nav');
        if (bottomNav) bottomNav.style.display = 'none';
        var fab = document.getElementById('fab');
        if (fab) fab.style.display = 'none';
    })();
    </script>
</body>
</html>
